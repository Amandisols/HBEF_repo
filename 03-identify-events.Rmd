---
title: "03-events"
author: "Amanda Pennino"
date: "2024-05-02"
output: html_document
---


#Input
# * Rain Gauge precipitation (15 min)

#Output
# * Delineated storm events


```{r}

library(tidyverse)
library(lubridate)

```

##############   CREATING PRECIP DATASETS   ##############

#DOWNLOAD THE LATEST PRECIP DATASET
- Data set title: Hubbard Brook Experimental Forest: 15-minute Precipitation Measurements, 2011 - present.
- Grab code and run in console: https://portal.edirepository.org/nis/codeGeneration?packageId=knb-lter-hbr.277.8&statisticalFileType=r
- Combine all rain gauges into list and convert DateTime to POSIXct format
- Last download: 05/10/2024

#REMOVE FLAGGED (FILLED) VALUES
- Anything with "1" = filled, not measured values
- Add in missing dates

#CALULCULATE MEDIAN VALUES FOR ALL 


#NOTES
- Data is in millimeters
- Gauge spelled as "gage"

```{r}

datesRG <- read_csv("~/projects/DSS/HBEF/HBEF_repo/rg_dates.csv")

# read in files
files = list.files(
  path = "timeseries/",
  pattern = "\\csv$",
  ignore.case = T,
  full.names = T
)


# read in rain gauge timeseries and combine into list
listRGs = lapply(files, read.csv)


# convert to POSIX format, set flagged precip values to NA
listRGs <- lapply(listRGs, function(x){
  x$DateTime = as.POSIXct(x$DateTime, format = "%Y-%m-%d %H:%M:%S", tz="GMT")
  x$precip[x$flag == 1] <- NA
  return(x)
})


# precip column names --> rain gauge name
for(i in 1:length(listRGs)) {
  colnames(listRGs[[i]]) <- c("index", "rainGage", "DateTime", listRGs[[i]]$rainGage[1], "flag")
}

# merge dfs
# remove unwanted columns before combing
listRGs <- lapply(listRGs, function(x) { x[c("index", "rainGage", "flag")] <- NULL; x })

# there's got to be a better way to do this...

seq <- data.frame(DateTime = seq(ymd_hm('2011-06-21 13:00'), ymd_hm('2024-01-01 13:00'), by = '15 mins'))
seq$DateTime= as.POSIXct(seq$DateTime, format = "%Y-%m-%d %H:%M:%S", tz="GMT")

allRGs_noflag <- seq %>%
  left_join(listRGs[[1]], by = "DateTime") %>%
  left_join(listRGs[[2]], by = "DateTime") %>%
  left_join(listRGs[[3]], by = "DateTime") %>%
  left_join(listRGs[[4]], by = "DateTime") %>%
  left_join(listRGs[[5]], by = "DateTime") %>%
  left_join(listRGs[[6]], by = "DateTime") %>%
  left_join(listRGs[[7]], by = "DateTime") %>%
  left_join(listRGs[[8]], by = "DateTime") %>%
  left_join(listRGs[[9]], by = "DateTime") %>%
  left_join(listRGs[[10]], by = "DateTime") 

allRGs_noflag$median_p <- apply(allRGs_noflag[2:11], 1, function(v) median(as.numeric(v), na.rm = T))

write.csv(allRGs_noflag, "timeseries/precip_allRGs_noflag.csv")

```




```{r}

##############   RAIN GAGE LOCATIONS   ##############
# library(sf)
# library(terra)
# 
# soils <- rast("rasters/hpu_hbef-2024.tif")
# ws <- read_sf("vectors/hbef_wsheds.shp")
# rg <- read_sf("vectors/hbef_raingage.shp")
# 
# GAGE <- as.numeric(unlist(rg$GAGE_NUM))
# 
# plot(soils)
# plot(ws, add = TRUE)
# plot(rg, add = TRUE, pch=20)
# text(rg, labels = GAGE, pos = 4, offset = 0.7) #why do labels not work???

```


##############   CREATING TARGET DATASET   ##############
```{r}


#flag: 0-directly measured, 1-gap-filled from all other stations (median value) for same time period
datesRG <- read_csv("~/projects/DSS/HBEF/HBEF_repo/rg_dates.csv")

medians <- read_csv("timeseries/precip_allRGs_noflag.csv") # median precip vals across watershed 3

RG4 <- read_csv("timeseries/edi/RG4.csv")[,-c(1,2)] #within ws 3

# time before RG4 logged
m <- medians %>%
  filter(DateTime < "2016-11-10 16:00:00") %>%
  select('DateTime', 'median_p') %>%
  rename(precip = 'median_p') %>%
  mutate(flag = 1)

RG4 <- rbind(m, RG4)


plot(RG4$DateTime, RG4$precip, type = "l")



```




